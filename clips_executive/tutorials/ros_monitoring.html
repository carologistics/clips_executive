<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Continuous Monitoring &mdash; clips_executive 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=86f27845" />

  
  
        <script src="../_static/jquery.js?v=8dae8fb0"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=01f34227"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing a Plugin for TF Monitoring" href="writing_a_plugin.html" />
    <link rel="prev" title="Hello World" href="hello_world.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            clips_executive
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">CLIPS Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugin_generator/index.html">ROS Interface Plugin Generator</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hello_world.html">Hello World</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Continuous Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Continuous Monitoring</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#obtaining-the-files">1 Obtaining the Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-the-cx">2 Configuring the ROS2 CLIPS-Executive</a></li>
<li class="toctree-l4"><a class="reference internal" href="#monitoring-the-turtle">3 Monitoring the Turtle</a></li>
<li class="toctree-l4"><a class="reference internal" href="#teleporting-the-turtle">4 Teleporting the Turtle</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-and-run">5 Build and Run</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="#next-steps">Next Steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="#related-content">Related Content</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="writing_a_plugin.html">Writing a Plugin for TF Monitoring</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../standards.html">Standard Documents</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">clips_executive</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Continuous Monitoring</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/ros_monitoring.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="continuous-monitoring">
<h1>Continuous Monitoring<a class="headerlink" href="#continuous-monitoring" title="Link to this heading"></a></h1>
<p><strong>Goal:</strong> Monitor the pose of a turtle from turtlesim using CLIPS</p>
<p><strong>Tutorial level:</strong> Beginner</p>
<p><strong>Time:</strong> 20 minutes</p>
<nav class="contents local" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id2">Background</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id3">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id4">Continuous Monitoring</a></p>
<ul>
<li><p><a class="reference internal" href="#obtaining-the-files" id="id5">1 Obtaining the Files</a></p></li>
<li><p><a class="reference internal" href="#configuring-the-cx" id="id6">2 Configuring the ROS2 CLIPS-Executive</a></p></li>
<li><p><a class="reference internal" href="#monitoring-the-turtle" id="id7">3 Monitoring the Turtle</a></p></li>
<li><p><a class="reference internal" href="#teleporting-the-turtle" id="id8">4 Teleporting the Turtle</a></p></li>
<li><p><a class="reference internal" href="#build-and-run" id="id9">5 Build and Run</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#summary" id="id10">Summary</a></p></li>
<li><p><a class="reference internal" href="#next-steps" id="id11">Next Steps</a></p></li>
<li><p><a class="reference internal" href="#related-content" id="id12">Related Content</a></p></li>
</ul>
</nav>
<section id="background">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Background</a><a class="headerlink" href="#background" title="Link to this heading"></a></h2>
<p>CLIPS can be used to continuouly monitor and control a robotic system.
This typically involves interleaving runs of the CLIPS inference engine with other components, e.g., to obtain feedback from ROS.</p>
</section>
<section id="prerequisites">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Prerequisites</a><a class="headerlink" href="#prerequisites" title="Link to this heading"></a></h2>
<p>This tutorial extends the <code class="docutils literal notranslate"><span class="pre">cx_tutorial_agents</span></code> package created in the <a class="reference internal" href="hello_world.html"><span class="doc">previous tutorial</span></a>.
Additionally, it requires the <a class="reference external" href="https://docs.ros.org/en/humble/p/turtlesim">turtlesim</a> package, which provides a minimal simulation environment to interact with.</p>
</section>
<section id="id1">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Continuous Monitoring</a><a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p>The objective of this tutorial is to provide a basic monitor for the turtlesim simulator, which teleports the turtle to the center whenever it is approaching the canvas frame.</p>
<p>To achieve this, the CLIPS environment has to get information from a ROS topic publishing the pose.
Whenever the pose is outside of the bounding box, a request to the teleport service is sent to reset the turtle to the center of the frame.</p>
<section id="obtaining-the-files">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">1 Obtaining the Files</a><a class="headerlink" href="#obtaining-the-files" title="Link to this heading"></a></h3>
<p>Navigate to the <code class="docutils literal notranslate"><span class="pre">params</span></code> directory of the <code class="docutils literal notranslate"><span class="pre">cx_tutorial_agents</span></code> package from the <a class="reference internal" href="hello_world.html"><span class="doc">Hello World tutorial</span></a> and download the configuration file using the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/ros2/cx_tutorial_ws/src/cx_tutorial_agents/params
wget<span class="w"> </span>-O<span class="w"> </span>tutlesim.yaml<span class="w"> </span>https://raw.githubusercontent.com/fawkesrobotics/ros2-clips-executive/master/tutorials/cx_tutorial_agents/params/turtlesim.yaml
</pre></div>
</div>
<p>This adds the file <code class="docutils literal notranslate"><span class="pre">turtlesim.yaml</span></code>.</p>
<p>Next, two CLIPS files can be downloaded to the <code class="docutils literal notranslate"><span class="pre">clips</span></code> directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/ros2/cx_tutorial_ws/src/cx_tutorial_agents/clips
wget<span class="w"> </span>-O<span class="w"> </span>tutlesim_monitor.clp<span class="w"> </span>https://raw.githubusercontent.com/fawkesrobotics/ros2-clips-executive/master/tutorials/cx_tutorial_agents/clips/turtlesim_monitor.clp
wget<span class="w"> </span>-O<span class="w"> </span>tutlesim_teleport.clp<span class="w"> </span>https://raw.githubusercontent.com/fawkesrobotics/ros2-clips-executive/master/tutorials/cx_tutorial_agents/clips/turtlesim_teleport.clp
</pre></div>
</div>
</section>
<section id="configuring-the-cx">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">2 Configuring the ROS2 CLIPS-Executive</a><a class="headerlink" href="#configuring-the-cx" title="Link to this heading"></a></h3>
<p>The CLIPS environment needs to:</p>
<ul class="simple">
<li><p>Continuously run the inference engine, which can be achieved with the  <a class="reference external" href="https://fawkesrobotics.github.io/ros2-clips-executive/clips_executive/plugins/executive_plugin">ExecutivePlugin</a>.</p></li>
<li><p>Establish ROS communication to other components, which is provided by the <a class="reference external" href="https://fawkesrobotics.github.io/ros2-clips-executive/clips_executive/plugins/ros_msgs_plugin">RosMsgsPlugin</a>.</p></li>
<li><p>Load our CLIPS files in the environment, using the <a class="reference external" href="https://fawkesrobotics.github.io/ros2-clips-executive/clips_executive/plugins/executive_plugin">FileLoadPlugin</a>.</p></li>
</ul>
<p>The following configuration is used to achieve this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">/**</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">autostart_node</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">environments</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;turtlesim_monitor&quot;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">turtlesim_monitor</span><span class="p">:</span>
<span class="w">      </span><span class="nt">plugins</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;executive&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;ros_msgs&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;files&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">log_clips_to_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">watch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;facts&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;rules&quot;</span><span class="p p-Indicator">]</span>


<span class="w">    </span><span class="nt">executive</span><span class="p">:</span>
<span class="w">      </span><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cx::ExecutivePlugin&quot;</span>

<span class="w">    </span><span class="nt">ros_msgs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cx::RosMsgsPlugin&quot;</span>

<span class="w">    </span><span class="nt">files</span><span class="p">:</span>
<span class="w">      </span><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cx::FileLoadPlugin&quot;</span>
<span class="w">      </span><span class="nt">pkg_share_dirs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;cx_tutorial_agents&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">load</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;clips/turtlesim_monitor.clp&quot;</span><span class="p p-Indicator">,</span>
<span class="w">             </span><span class="s">&quot;clips/turtlesim_teleport.clp&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>Again, the parameter file starts by configuring the node to automatically activate and then to setup a CLIPS environment, this time named <code class="docutils literal notranslate"><span class="pre">turtlesim_monitor</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">/**</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">autostart_node</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">environments</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;turtlesim_monitor&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>This time, three plugins are needed, which are further specified afterwards.
The plugins are loaded in the same order as they are specified.
This is important as the loaded CLIPS files will contain functions from the other plugins, hence it must be loaded last.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">turtlesim_monitor</span><span class="p">:</span>
<span class="w">  </span><span class="nt">plugins</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;executive&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;ros_msgs&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;files&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">log_clips_to_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">watch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;facts&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;rules&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>The plugins for <a class="reference external" href="https://fawkesrobotics.github.io/ros2-clips-executive/clips_executive/plugins/executive_plugin">continuous execution</a> and <a class="reference external" href="https://fawkesrobotics.github.io/ros2-clips-executive/clips_executive/plugins/ros_msgs_plugin">ROS communication</a> are used as-is whithout further configuration.
The former calls the CLIPS inference engine with a fixed frequency, the latter provides CLIPS functions and templates for interfacing with ROS.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">executive</span><span class="p">:</span>
<span class="w">  </span><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cx::ExecutivePlugin&quot;</span>

<span class="nt">ros_msgs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cx::RosMsgsPlugin&quot;</span>
</pre></div>
</div>
<p>Lastly, the <a class="reference external" href="https://fawkesrobotics.github.io/ros2-clips-executive/clips_executive/plugins/file_load_plugin">FileLoadPlugin</a> is used to obtain the files.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">files</span><span class="p">:</span>
<span class="w">  </span><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cx::FileLoadPlugin&quot;</span>
<span class="w">  </span><span class="nt">pkg_share_dirs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;cx_tutorial_agents&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">load</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;clips/turtlesim_monitor.clp&quot;</span><span class="p p-Indicator">,</span>
<span class="w">         </span><span class="s">&quot;clips/turtlesim_teleport.clp&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</section>
<section id="monitoring-the-turtle">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">3 Monitoring the Turtle</a><a class="headerlink" href="#monitoring-the-turtle" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">turtlesim_monitor.clp</span></code> file provides a set of rules to listen to the <code class="docutils literal notranslate"><span class="pre">Pose</span></code> topic of <code class="docutils literal notranslate"><span class="pre">turtle1</span></code> and to detect if the pose leaves a defined safe area.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defglobal</span>
<span class="w">  </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="s">&quot;turtle1/pose&quot;</span>
<span class="w">  </span><span class="nv">?*TURTLE-POSE-TYPE*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="s">&quot;turtlesim/msg/Pose&quot;</span>
<span class="w">  </span><span class="nv">?*SAFE-AREA-LOWER-BOUND*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">  </span><span class="nv">?*SAFE-AREA-UPPER-BOUND*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="mf">10.0</span>
<span class="p">)</span>

<span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-pose-topic-create-subscription</span>
<span class="s">&quot; Create subscription to monitor the pose.&quot;</span>
<span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">unwatch</span><span class="w"> </span><span class="nv">facts</span><span class="w"> </span><span class="nv">ros-msgs-message</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">unwatch</span><span class="w"> </span><span class="nv">rules</span><span class="w"> </span><span class="nv">turtle-pose-receive</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-create-subscription</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TYPE*</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="s">&quot;Listening to &quot;</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="p">)</span>

<span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-pose-receive</span>
<span class="s">&quot; React to incoming messages andcheck for critical pose. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-subscription</span><span class="w"> </span><span class="p">(</span><span class="nv">topic</span><span class="w"> </span><span class="nv">?t&amp;:</span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="nv">?t</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="p">)))</span>
<span class="w">  </span><span class="nv">?msg-f</span><span class="w"> </span><span class="nv">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-message</span><span class="w"> </span><span class="p">(</span><span class="nv">topic</span><span class="w"> </span><span class="nv">?t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">msg-ptr</span><span class="w"> </span><span class="nv">?inc-msg</span><span class="p">))</span>
<span class="w">  </span><span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">bind</span><span class="w"> </span><span class="nv">?x</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-get-field</span><span class="w"> </span><span class="nv">?inc-msg</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">bind</span><span class="w"> </span><span class="nv">?y</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-get-field</span><span class="w"> </span><span class="nv">?inc-msg</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span>
<span class="w">    </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="nv">?x</span><span class="w"> </span><span class="nv">?*SAFE-AREA-LOWER-BOUND*</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="nv">?y</span><span class="w"> </span><span class="nv">?*SAFE-AREA-LOWER-BOUND*</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">?x</span><span class="w"> </span><span class="nv">?*SAFE-AREA-UPPER-BOUND*</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">?y</span><span class="w"> </span><span class="nv">?*SAFE-AREA-UPPER-BOUND*</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nv">then</span>
<span class="w">    </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">yellow</span><span class="w"> </span><span class="s">&quot;turtle out of bounds&quot;</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nv">turtle-out-of-bounds</span><span class="p">))</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-destroy-message</span><span class="w"> </span><span class="nv">?inc-msg</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">retract</span><span class="w"> </span><span class="nv">?msg-f</span><span class="p">)</span>
<span class="p">)</span>

<span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-pose-destroy-subscription</span>
<span class="s">&quot; Delete the subscription on executive finalize. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">executive-finalize</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-subscription</span><span class="w"> </span><span class="p">(</span><span class="nv">topic</span><span class="w"> </span><span class="nv">?t&amp;:</span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="nv">?t</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="p">)))</span>
<span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="s">&quot;Destroying subscription for &quot;</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-destroy-subscription</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>First, some global variables are defined for convenience:</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defglobal</span>
<span class="w">  </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="s">&quot;turtle1/pose&quot;</span>
<span class="w">  </span><span class="nv">?*TURTLE-POSE-TYPE*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="s">&quot;turtlesim/msg/Pose&quot;</span>
<span class="w">  </span><span class="nv">?*SAFE-AREA-LOWER-BOUND*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">  </span><span class="nv">?*SAFE-AREA-UPPER-BOUND*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="mf">10.0</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The rest of the file is comprised of individual CLIPS rules, which rely on the features provided by the <code class="docutils literal notranslate"><span class="pre">RosMsgsPlugin</span></code>. Specifically, here you need to utilize:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ros-msgs-subscription</span></code>: A fact template for storing currently open subscriptions. A fact of that template is created via the function <code class="docutils literal notranslate"><span class="pre">ros-msgs-create-subscription</span></code> and destroyed via <code class="docutils literal notranslate"><span class="pre">ros-msgs-destroy-subscription</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ros-msgs-message</span></code>: A fact template holding messages. Facts of this template are asserted whenever an open subscription receives a message.</p></li>
<li><p>Utility functions <code class="docutils literal notranslate"><span class="pre">ros-msgs-get-field</span></code> and <code class="docutils literal notranslate"><span class="pre">ros-msgs-destroy-message</span></code> to handle the incoming messages.</p></li>
</ul>
<p>Refer to the <a class="reference external" href="https://fawkesrobotics.github.io/ros2-clips-executive/clips_executive/plugins/ros_msgs_plugin">RosMsgsPlugin documentation</a> for more information and a complete list of provided features.</p>
<p>Then, a rule called <code class="docutils literal notranslate"><span class="pre">turtle-pose-topic-create-subscription</span></code> is defined, which creates the subsciption to the <code class="docutils literal notranslate"><span class="pre">turtle1/pose</span></code> pose using the ROS communication plugin. It has no condition, hence can be executed right away.
Before the subscription is established, it unwatches the <code class="docutils literal notranslate"><span class="pre">ros-msgs-message</span></code> template and <code class="docutils literal notranslate"><span class="pre">turtle-pose-receive</span></code> rule, which processes the message facts. This greatly reduces the amount of log output as data is published with high frequency on this topic.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-pose-topic-create-subscription</span>
<span class="s">&quot; Create subscription to monitor the pose.&quot;</span>
<span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">unwatch</span><span class="w"> </span><span class="nv">facts</span><span class="w"> </span><span class="nv">ros-msgs-message</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">unwatch</span><span class="w"> </span><span class="nv">rules</span><span class="w"> </span><span class="nv">turtle-pose-receive</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-create-subscription</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TYPE*</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="s">&quot;Listening to &quot;</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The next rule <code class="docutils literal notranslate"><span class="pre">turtle-pose-receive</span></code> processes each incoming message from the pose topic and if the received (x,y) coordinate is outside of the safe area, it asserts a fact <code class="docutils literal notranslate"><span class="pre">(turtle-out-of-bounds)</span></code>. This will be the trigger for another set of rules to teleport the turtle back to the center of the safe area.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-pose-receive</span>
<span class="s">&quot; React to incoming messages andcheck for critical pose. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-subscription</span><span class="w"> </span><span class="p">(</span><span class="nv">topic</span><span class="w"> </span><span class="nv">?t&amp;:</span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="nv">?t</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="p">)))</span>
<span class="w">  </span><span class="nv">?msg-f</span><span class="w"> </span><span class="nv">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-message</span><span class="w"> </span><span class="p">(</span><span class="nv">topic</span><span class="w"> </span><span class="nv">?t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">msg-ptr</span><span class="w"> </span><span class="nv">?inc-msg</span><span class="p">))</span>
<span class="w">  </span><span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">bind</span><span class="w"> </span><span class="nv">?x</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-get-field</span><span class="w"> </span><span class="nv">?inc-msg</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">bind</span><span class="w"> </span><span class="nv">?y</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-get-field</span><span class="w"> </span><span class="nv">?inc-msg</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span>
<span class="w">    </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="nv">?x</span><span class="w"> </span><span class="nv">?*SAFE-AREA-LOWER-BOUND*</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="nv">?y</span><span class="w"> </span><span class="nv">?*SAFE-AREA-LOWER-BOUND*</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">?x</span><span class="w"> </span><span class="nv">?*SAFE-AREA-UPPER-BOUND*</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">?y</span><span class="w"> </span><span class="nv">?*SAFE-AREA-UPPER-BOUND*</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nv">then</span>
<span class="w">    </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">yellow</span><span class="w"> </span><span class="s">&quot;turtle out of bounds&quot;</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nv">turtle-out-of-bounds</span><span class="p">))</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-destroy-message</span><span class="w"> </span><span class="nv">?inc-msg</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">retract</span><span class="w"> </span><span class="nv">?msg-f</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Lastly, the rule <code class="docutils literal notranslate"><span class="pre">turtle-pose-destroy-subscription</span></code> closes the subscription when the ROS2 CLIPS-Executive stops the environment.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-pose-destroy-subscription</span>
<span class="s">&quot; Delete the subscription on executive finalize. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">executive-finalize</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-subscription</span><span class="w"> </span><span class="p">(</span><span class="nv">topic</span><span class="w"> </span><span class="nv">?t&amp;:</span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="nv">?t</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="p">)))</span>
<span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="s">&quot;Destroying subscription for &quot;</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-destroy-subscription</span><span class="w"> </span><span class="nv">?*TURTLE-POSE-TOPIC*</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="teleporting-the-turtle">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">4 Teleporting the Turtle</a><a class="headerlink" href="#teleporting-the-turtle" title="Link to this heading"></a></h3>
<p>The file <code class="docutils literal notranslate"><span class="pre">turtlesim_teleport.clp</span></code> contains a set of rule that will teleport the turtle back to the center of the canvas, whenever it leaves the safe area, as indidicated by the <code class="docutils literal notranslate"><span class="pre">(turtle-out-of-bounds)</span></code> fact.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defglobal</span>
<span class="w">  </span><span class="nv">?*TURTLE-SERVICE*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="s">&quot;turtle1/teleport_absolute&quot;</span>
<span class="w">  </span><span class="nv">?*TURTLE-TELEPORT-TYPE*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="s">&quot;turtlesim/srv/TeleportAbsolute&quot;</span>
<span class="p">)</span>

<span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-teleport-client-init</span>
<span class="s">&quot; Create publisher for ros_cx_out.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-client</span><span class="w"> </span><span class="p">(</span><span class="nv">service</span><span class="w"> </span><span class="nv">?s&amp;:</span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="nv">?s</span><span class="w"> </span><span class="nv">?*TURTLE-SERVICE*</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nv">executive-finalize</span><span class="p">))</span>
<span class="nv">=&gt;</span>
<span class="w">  </span><span class="c1">; create the client</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-create-client</span><span class="w"> </span><span class="nv">?*TURTLE-SERVICE*</span><span class="w"> </span><span class="nv">?*TURTLE-TELEPORT-TYPE*</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">green</span><span class="w"> </span><span class="s">&quot;Opening client for &quot;</span><span class="w"> </span><span class="nv">?*TURTLE-SERVICE*</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="p">)</span>

<span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-teleport-request-teleport-mid</span>
<span class="s">&quot; Attempt to request the service. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-client</span><span class="w"> </span><span class="p">(</span><span class="nv">service</span><span class="w"> </span><span class="nv">?service&amp;:</span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="nv">?service</span><span class="w"> </span><span class="nv">?*TURTLE-SERVICE*</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nv">request</span><span class="w"> </span><span class="nv">?any-id</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">turtle-out-of-bounds</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">time</span><span class="w"> </span><span class="nv">?any-time</span><span class="p">)</span><span class="w"> </span><span class="c1">; used to continuously attempt to request the service until success</span>
<span class="w">  </span><span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">bind</span><span class="w"> </span><span class="nv">?new-req</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-create-request</span><span class="w"> </span><span class="nv">?*TURTLE-TELEPORT-TYPE*</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-set-field</span><span class="w"> </span><span class="nv">?new-req</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="w"> </span><span class="mf">5.5</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-set-field</span><span class="w"> </span><span class="nv">?new-req</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="w"> </span><span class="mf">5.5</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">bind</span><span class="w"> </span><span class="nv">?id</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-async-send-request</span><span class="w"> </span><span class="nv">?new-req</span><span class="w"> </span><span class="nv">?service</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">?id</span><span class="w"> </span><span class="nv">then</span>
<span class="w">    </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">yellow</span><span class="w"> </span><span class="s">&quot;Request sent with id &quot;</span><span class="w"> </span><span class="nv">?id</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nv">request</span><span class="w"> </span><span class="nv">?id</span><span class="p">))</span>
<span class="w">   </span><span class="nv">else</span>
<span class="w">    </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">red</span><span class="w"> </span><span class="s">&quot;Sending of request failed, is the service running?&quot;</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">red</span><span class="w"> </span><span class="s">&quot;Start it using \&quot;ros2 run turtlesim turtlesim_node\&quot;&quot;</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-destroy-message</span><span class="w"> </span><span class="nv">?new-req</span><span class="p">)</span>
<span class="p">)</span>

<span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-teleport-done</span>
<span class="s">&quot; Got response, delete it without reading, it is empty.&quot;</span>
<span class="w">  </span><span class="nv">?msg-fact</span><span class="w"> </span><span class="nv">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-response</span><span class="w"> </span><span class="p">(</span><span class="nv">service</span><span class="w"> </span><span class="nv">?service</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">msg-ptr</span><span class="w"> </span><span class="nv">?ptr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">request-id</span><span class="w"> </span><span class="nv">?id</span><span class="p">))</span>
<span class="w">  </span><span class="nv">?request-fact</span><span class="w"> </span><span class="nv">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nv">request</span><span class="w"> </span><span class="nv">?id</span><span class="p">)</span>
<span class="w">  </span><span class="nv">?out-of-bounds-fact</span><span class="w"> </span><span class="nv">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nv">turtle-out-of-bounds</span><span class="p">)</span>
<span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">yellow</span><span class="w"> </span><span class="s">&quot;Turtle teleport done (request id &quot;</span><span class="w"> </span><span class="nv">?id</span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-destroy-message</span><span class="w"> </span><span class="nv">?ptr</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">retract</span><span class="w"> </span><span class="nv">?msg-fact</span><span class="w"> </span><span class="nv">?request-fact</span><span class="w"> </span><span class="nv">?out-of-bounds-fact</span><span class="p">)</span>
<span class="p">)</span>

<span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-teleport-client-finalize</span>
<span class="s">&quot; Delete the client on executive finalize. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">executive-finalize</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-client</span><span class="w"> </span><span class="p">(</span><span class="nv">service</span><span class="w"> </span><span class="nv">?service</span><span class="p">))</span>
<span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="s">&quot;Destroying client&quot;</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-destroy-client</span><span class="w"> </span><span class="nv">?service</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Again, the file begins with some global constants for convenience.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defglobal</span>
<span class="w">  </span><span class="nv">?*TURTLE-SERVICE*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="s">&quot;turtle1/teleport_absolute&quot;</span>
<span class="w">  </span><span class="nv">?*TURTLE-TELEPORT-TYPE*</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="s">&quot;turtlesim/srv/TeleportAbsolute&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Similar to handling subscriptions and messages, the <code class="docutils literal notranslate"><span class="pre">RosMsgsPlugin</span></code> also supports the creation of ROS service clients to send service requests.
The <code class="docutils literal notranslate"><span class="pre">turtle-teleport-client-init</span></code> rule simply ensures a client to the <code class="docutils literal notranslate"><span class="pre">turtle1/teleport_absolute</span></code> service is created.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-teleport-client-init</span>
<span class="s">&quot; Create publisher for ros_cx_out.&quot;</span>
<span class="nv">=&gt;</span>
<span class="w">  </span><span class="c1">; create the client</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-create-client</span><span class="w"> </span><span class="nv">?*TURTLE-SERVICE*</span><span class="w"> </span><span class="nv">?*TURTLE-TELEPORT-TYPE*</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">green</span><span class="w"> </span><span class="s">&quot;Opening client for &quot;</span><span class="w"> </span><span class="nv">?*TURTLE-SERVICE*</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">turtle-teleport-request-teleport-mid</span></code> rule can be activated once the client is established and the turtle is out of bounds.
Additionally, it is conditioned on the current time, a fact updated by the <code class="docutils literal notranslate"><span class="pre">ExecutivePlugin</span></code> in between each inference engine run.
This allows the rule to fire at each iteration if needed (e.g., if the service is not reachable).
The rule effect takes care of creating and sending the request.
If the request is successfully sent, it asserts a request fact (including the request ID assigned to it), indicating that the request is now processed asynchronously and preventing the rule to fire again.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-teleport-request-teleport-mid</span>
<span class="s">&quot; Attempt to request the service. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-client</span><span class="w"> </span><span class="p">(</span><span class="nv">service</span><span class="w"> </span><span class="nv">?service&amp;:</span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="nv">?service</span><span class="w"> </span><span class="nv">?*TURTLE-SERVICE*</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">turtle-out-of-bounds</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nv">request</span><span class="w"> </span><span class="nv">?any-id</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nb">time</span><span class="w"> </span><span class="nv">?any-time</span><span class="p">)</span><span class="w"> </span><span class="c1">; used to continuously attempt to request the service until success</span>
<span class="w">  </span><span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">bind</span><span class="w"> </span><span class="nv">?new-req</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-create-request</span><span class="w"> </span><span class="nv">?*TURTLE-TELEPORT-TYPE*</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-set-field</span><span class="w"> </span><span class="nv">?new-req</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="w"> </span><span class="mf">5.5</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-set-field</span><span class="w"> </span><span class="nv">?new-req</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="w"> </span><span class="mf">5.5</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">bind</span><span class="w"> </span><span class="nv">?id</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-async-send-request</span><span class="w"> </span><span class="nv">?new-req</span><span class="w"> </span><span class="nv">?service</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">?id</span><span class="w"> </span><span class="nv">then</span>
<span class="w">    </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">yellow</span><span class="w"> </span><span class="s">&quot;Request sent with id &quot;</span><span class="w"> </span><span class="nv">?id</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nv">request</span><span class="w"> </span><span class="nv">?id</span><span class="p">))</span>
<span class="w">   </span><span class="nv">else</span>
<span class="w">    </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">red</span><span class="w"> </span><span class="s">&quot;Sending of request failed, is the service running?&quot;</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">red</span><span class="w"> </span><span class="s">&quot;Start it using \&quot;ros2 run turtlesim turtlesim_node\&quot;&quot;</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-destroy-message</span><span class="w"> </span><span class="nv">?new-req</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The rule <code class="docutils literal notranslate"><span class="pre">turtle-teleport-done</span></code> processes the response of the service request. The <code class="docutils literal notranslate"><span class="pre">TeleportAbsolute</span></code> service does not provide an explicit response, hence the rule simply cleans it up, along with the facts indicating the turtle being out of bounds <code class="docutils literal notranslate"><span class="pre">(turtle-out-of-bounds)</span></code> and that the request awaited an answer <code class="docutils literal notranslate"><span class="pre">(request</span> <span class="pre">?id)</span></code>.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-teleport-done</span>
<span class="s">&quot; Got response, delete it without reading, it is empty.&quot;</span>
<span class="w">  </span><span class="nv">?msg-fact</span><span class="w"> </span><span class="nv">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nv">ros-msgs-response</span><span class="w"> </span><span class="p">(</span><span class="nv">service</span><span class="w"> </span><span class="nv">?service</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">msg-ptr</span><span class="w"> </span><span class="nv">?ptr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">request-id</span><span class="w"> </span><span class="nv">?id</span><span class="p">))</span>
<span class="w">  </span><span class="nv">?request-fact</span><span class="w"> </span><span class="nv">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nv">request</span><span class="w"> </span><span class="nv">?id</span><span class="p">)</span>
<span class="w">  </span><span class="nv">?out-of-bounds-fact</span><span class="w"> </span><span class="nv">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nv">turtle-out-of-bounds</span><span class="p">)</span>
<span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">yellow</span><span class="w"> </span><span class="s">&quot;Turtle teleport done (request id &quot;</span><span class="w"> </span><span class="nv">?id</span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-destroy-message</span><span class="w"> </span><span class="nv">?ptr</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">retract</span><span class="w"> </span><span class="nv">?msg-fact</span><span class="w"> </span><span class="nv">?request-fact</span><span class="w"> </span><span class="nv">?out-of-bounds-fact</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Lastly, the rule <code class="docutils literal notranslate"><span class="pre">turtle-teleport-client-finalize</span></code> takes care of removing the client on shutdown of the environment.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defrule</span><span class="w"> </span><span class="nv">turtle-teleport-client-finalize</span>
<span class="s">&quot; Delete the client on executive finalize. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">executive-finalize</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-client</span><span class="w"> </span><span class="p">(</span><span class="nv">service</span><span class="w"> </span><span class="nv">?service</span><span class="p">))</span>
<span class="nv">=&gt;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">printout</span><span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="s">&quot;Destroying client&quot;</span><span class="w"> </span><span class="nv">crlf</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">ros-msgs-destroy-client</span><span class="w"> </span><span class="nv">?service</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="build-and-run">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">5 Build and Run</a><a class="headerlink" href="#build-and-run" title="Link to this heading"></a></h3>
<p>First, build the package ans source it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/ros2/cx_tutorial_ws/
colcon<span class="w"> </span>build<span class="w"> </span>--symlink-install
<span class="nb">source</span><span class="w"> </span>install/setup.bash
</pre></div>
</div>
<p>Using the launch file of the <code class="docutils literal notranslate"><span class="pre">cx_bringup</span></code> package, you can start the CLIPS environment with the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>launch<span class="w"> </span>cx_bringup<span class="w"> </span>cx_launch.py<span class="w"> </span>manager_config:<span class="o">=</span>turtlesim.yaml<span class="w"> </span>package:<span class="o">=</span>cx_tutorial_agents
</pre></div>
</div>
<p>Run the turtlesim simulation in a different terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>run<span class="w"> </span>turtlesim<span class="w"> </span>turtlesim_node
</pre></div>
</div>
<p>In a third terminal you can run the turtle_teleop_key node to control the turtle with your keyboard.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>run<span class="w"> </span>turtlesim<span class="w"> </span>turtle_teleop_key
</pre></div>
</div>
<p>When attempting to hit the canvas border you will see the turtle spawning back to the center. The output from CLIPS will look like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>FIRE<span class="w">    </span><span class="m">1</span><span class="w"> </span>turtle-pose-topic-create-subscription:<span class="w"> </span>*
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span><span class="o">==</span>&gt;<span class="w"> </span>f-1<span class="w">     </span><span class="o">(</span>ros-msgs-subscription<span class="w"> </span><span class="o">(</span>topic<span class="w"> </span><span class="s2">&quot;turtle1/pose&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;turtlesim/msg/Pose&quot;</span><span class="o">))</span>
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>Listening<span class="w"> </span>to<span class="w"> </span>turtle1/pose
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>FIRE<span class="w">    </span><span class="m">2</span><span class="w"> </span>turtle-teleport-client-init:<span class="w"> </span>*
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span><span class="o">==</span>&gt;<span class="w"> </span>f-2<span class="w">     </span><span class="o">(</span>ros-msgs-client<span class="w"> </span><span class="o">(</span>service<span class="w"> </span><span class="s2">&quot;turtle1/teleport_absolute&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;turtlesim/srv/TeleportAbsolute&quot;</span><span class="o">))</span>
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>Opening<span class="w"> </span>client<span class="w"> </span><span class="k">for</span><span class="w"> </span>turtle1/teleport_absolute
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>turtle<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span>bounds
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span><span class="o">==</span>&gt;<span class="w"> </span>f-2980<span class="w">  </span><span class="o">(</span>turtle-out-of-bounds<span class="o">)</span>
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>FIRE<span class="w">    </span><span class="m">2</span><span class="w"> </span>turtle-teleport-request-teleport-mid:<span class="w"> </span>f-2,*,f-2980,f-2979
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>Request<span class="w"> </span>sent<span class="w"> </span>with<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span><span class="o">==</span>&gt;<span class="w"> </span>f-2981<span class="w">  </span><span class="o">(</span>request<span class="w"> </span><span class="m">1</span><span class="o">)</span>
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>turtle<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span>bounds
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>turtle<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span>bounds
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>turtle<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span>bounds
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>turtle<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span>bounds
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>turtle<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span>bounds
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span><span class="o">==</span>&gt;<span class="w"> </span>f-2983<span class="w">  </span><span class="o">(</span>ros-msgs-response<span class="w"> </span><span class="o">(</span>service<span class="w"> </span><span class="s2">&quot;turtle1/teleport_absolute&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">(</span>request-id<span class="w"> </span><span class="m">1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span>msg-ptr<span class="w"> </span>&lt;Pointer-C-0x7f639c000bb0&gt;<span class="o">))</span>
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>FIRE<span class="w">    </span><span class="m">6</span><span class="w"> </span>turtle-teleport-done:<span class="w"> </span>f-2983,f-2981,f-2980
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>Turtle<span class="w"> </span>teleport<span class="w"> </span><span class="k">done</span><span class="w"> </span><span class="o">(</span>request<span class="w"> </span>id<span class="w"> </span><span class="m">1</span><span class="o">)</span>
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>&lt;<span class="o">==</span><span class="w"> </span>f-2983<span class="w">  </span><span class="o">(</span>ros-msgs-response<span class="w"> </span><span class="o">(</span>service<span class="w"> </span><span class="s2">&quot;turtle1/teleport_absolute&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">(</span>request-id<span class="w"> </span><span class="m">1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span>msg-ptr<span class="w"> </span>&lt;Pointer-C-0x7f639c000bb0&gt;<span class="o">))</span>
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>&lt;<span class="o">==</span><span class="w"> </span>f-2981<span class="w">  </span><span class="o">(</span>request<span class="w"> </span><span class="m">1</span><span class="o">)</span>
<span class="o">[</span>&lt;timestamp&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>turtlesim_monitor<span class="o">]</span><span class="w"> </span><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>&lt;<span class="o">==</span><span class="w"> </span>f-2980<span class="w">  </span><span class="o">(</span>turtle-out-of-bounds<span class="o">)</span>
</pre></div>
</div>
</section>
</section>
<section id="summary">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Link to this heading"></a></h2>
<p>You leveraged the <code class="docutils literal notranslate"><span class="pre">ExecutivePlugin</span></code> to subsequently run the CLIPS inference engine indefinitevely. Together with the <code class="docutils literal notranslate"><span class="pre">RosMsgsPlugin</span></code> this enabled you to receive the latest updates from ROS topics in CLIPS.
You utilized this to monitor the turtlesim simulator in order to prevent the turtle from hitting the canvas border.</p>
</section>
<section id="next-steps">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Next Steps</a><a class="headerlink" href="#next-steps" title="Link to this heading"></a></h2>
<p>You can check out the other plugins offered by the ROS2 CLIPS-Executive <a class="reference external" href="https://fawkesrobotics.github.io/ros2-clips-executive/clips_executive/plugins">here</a>.
Also, you can learn how to <a class="reference internal" href="writing_a_plugin.html"><span class="doc">write your own CLIPS plugin</span></a>.</p>
</section>
<section id="related-content">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Related Content</a><a class="headerlink" href="#related-content" title="Link to this heading"></a></h2>
<p>Providing a service or utilizing ROS actions requires additional work, as general ROS introspection support is currently limited to messages and service clients in the latest ROS LTS version.</p>
<p>Therefore, the ROS2 CLIPS-Executive offers the <a class="reference external" href="https://fawkesrobotics.github.io/ros2-clips-executive/clips_executive/plugin_generator">ROS Interface Plugin Generator</a> to bridge this gap.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="hello_world.html" class="btn btn-neutral float-left" title="Hello World" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="writing_a_plugin.html" class="btn btn-neutral float-right" title="Writing a Plugin for TF Monitoring" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tarik Viehmann.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>