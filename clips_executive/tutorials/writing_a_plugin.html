<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writing a Plugin for TF Monitoring &mdash; clips_executive 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=86f27845" />

  
  
        <script src="../_static/jquery.js?v=8dae8fb0"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=01f34227"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Continuous Monitoring" href="ros_monitoring.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            clips_executive
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">CLIPS Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugin_generator/index.html">ROS Interface Plugin Generator</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hello_world.html">Hello World</a></li>
<li class="toctree-l2"><a class="reference internal" href="ros_monitoring.html">Continuous Monitoring</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Writing a Plugin for TF Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tf-monitoring-plugin">TF Monitoring Plugin</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#obtaining-the-files">1 Obtaining the Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plugin-package-setup">2 Plugin Package Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plugin-class-structure">3 Plugin Class Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#opening-ros-interfaces-on-initialize">4 Opening ROS Interfaces on initialize()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cleaning-up-references-on-finalize">5 Cleaning Up References On finalize()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-templates-and-functions-in-clips-env-init">6 Adding Templates and Functions in clips_env_init()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cleaning-up-with-the-help-of-stop-periodic-lookup">8 Cleaning Up with the Help of stop_periodic_lookup()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-code">9 Running The Code</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">clips_executive</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Writing a Plugin for TF Monitoring</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/writing_a_plugin.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="writing-a-plugin-for-tf-monitoring">
<h1>Writing a Plugin for TF Monitoring<a class="headerlink" href="#writing-a-plugin-for-tf-monitoring" title="Link to this heading"></a></h1>
<p><strong>Goal:</strong> Implement a CLIPS Plugin to observe transforms of a turtle from turtlesim</p>
<p><strong>Tutorial level:</strong> Advanced</p>
<p><strong>Time:</strong> 45 minutes</p>
<nav class="contents local" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id3">Background</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id4">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#tf-monitoring-plugin" id="id5">TF Monitoring Plugin</a></p>
<ul>
<li><p><a class="reference internal" href="#obtaining-the-files" id="id6">1 Obtaining the Files</a></p></li>
<li><p><a class="reference internal" href="#plugin-package-setup" id="id7">2 Plugin Package Setup</a></p></li>
<li><p><a class="reference internal" href="#plugin-class-structure" id="id8">3 Plugin Class Structure</a></p></li>
<li><p><a class="reference internal" href="#opening-ros-interfaces-on-initialize" id="id9">4 Opening ROS Interfaces on initialize()</a></p></li>
<li><p><a class="reference internal" href="#cleaning-up-references-on-finalize" id="id10">5 Cleaning Up References On finalize()</a></p></li>
<li><p><a class="reference internal" href="#adding-templates-and-functions-in-clips-env-init" id="id11">6 Adding Templates and Functions in clips_env_init()</a></p></li>
<li><p><a class="reference internal" href="#cleaning-up-with-the-help-of-stop-periodic-lookup" id="id12">8 Cleaning Up with the Help of stop_periodic_lookup()</a></p></li>
<li><p><a class="reference internal" href="#running-the-code" id="id13">9 Running The Code</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="background">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Background</a><a class="headerlink" href="#background" title="Link to this heading"></a></h2>
<p>Plugins can be used to access CLIPS environments via their C++ API, as detailed in the <a class="reference external" href="https://clipsrules.net/documentation/v641/apg641.pdf">Advanced Programming Guide (PDF)</a>.
This allows users to customize CLIPS to their needs.</p>
</section>
<section id="prerequisites">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Prerequisites</a><a class="headerlink" href="#prerequisites" title="Link to this heading"></a></h2>
<p>This tutorial extends the <code class="docutils literal notranslate"><span class="pre">cx_tut_agent</span></code> package created in the <a class="reference internal" href="hello_world.html"><span class="doc">previous tutorial</span></a>.
Additionally, it requires the <a class="reference external" href="https://docs.ros.org/en/humble/p/turtlesim">turtlesim</a> package, which provides a minimal simulation environment to interact with and the <a class="reference external" href="https://docs.ros.org/en/humble/p/turtle_tf2_py">turtle_tf2_py</a> package to obtain transforms from the simulation.</p>
<p>The introductory tutorial for <a class="reference external" href="https://docs.ros.org/en/humble/Tutorials/Beginner-Client-Libraries/Pluginlib.html">pluginlib</a> is a helpful resource to get a general understanding of <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code> plugins, as those are not discussed in detail here.</p>
<p>Similarly, the introduction to <a class="reference external" href="https://docs.ros.org/en/humble/Tutorials/Intermediate/Tf2/Writing-A-Tf2-Listener-Cpp.html">tf2 listeners</a>  explains the basics for observing transforms via <code class="docutils literal notranslate"><span class="pre">tf2</span></code>, which is utilized in this tutorial.</p>
</section>
<section id="tf-monitoring-plugin">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">TF Monitoring Plugin</a><a class="headerlink" href="#tf-monitoring-plugin" title="Link to this heading"></a></h2>
<p>The objective of this tutorial is to write a custom CLIPS plugin that asynchronously injects poses obtained from a transform tree into a running CLIPS environment.</p>
<p>This involves:</p>
<ul class="simple">
<li><p>Setting up a class that derives from the base plugin definition.</p></li>
<li><p>Adding a TF listener to query the transform tree on demand.</p></li>
<li><p>Providing a CLIPS template for storing tf data, as well as CLIPS functions for starting and stopping periodic tf lookups.</p></li>
<li><p>Managing asynchronous callbacks to update the fact base as needed.</p></li>
<li><p>Handling CLIPS data and garbage collection.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Throughout this this tutorial, the CLIPS C(++) API is used extensively.
When working with the API you should familiarize yourself with the <a class="reference external" href="https://docs.ros.org/en/humble/p/clips_vendor">clips_vendor</a> package and the namespaced CLIPS target it provides, as well as the <a class="reference external" href="https://clipsrules.net/documentation/v641/apg641.pdf">Advanced Programming Guide (PDF)</a>, which is the reference manual for all public interfaces of CLIPS.</p>
</div>
<section id="obtaining-the-files">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">1 Obtaining the Files</a><a class="headerlink" href="#obtaining-the-files" title="Link to this heading"></a></h3>
<p>Navigate to the <code class="docutils literal notranslate"><span class="pre">params</span></code> directory of the <code class="docutils literal notranslate"><span class="pre">clips_tut_agent</span></code> package from the <a class="reference internal" href="hello_world.html"><span class="doc">Hello World tutorial</span></a> and download the configuration file using the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/ros2/cx_tutorial_ws/src/clips_tut_agent/params
wget<span class="w"> </span>-O<span class="w"> </span>tf2_tracked_pose.yaml<span class="w"> </span>https://raw.githubusercontent.com/fawkesrobotics/ros2-clips-executive/master/tutorials/clips_tut_agent/params/tf2_tracked_pose.yaml
</pre></div>
</div>
<p>This adds the file <code class="docutils literal notranslate"><span class="pre">tf2_tracked_pose.yaml</span></code> for setting up the ROS2 CLIPS-Executive for this tutorial.</p>
<p>Next, a CLIPS file <code class="docutils literal notranslate"><span class="pre">tf2_tracked_pose.clp</span></code> can be downloaded to the <code class="docutils literal notranslate"><span class="pre">clips</span></code> directory, providing a minimal example to test the plugin:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/ros2/cx_tutorial_ws/src/clips_tut_agent/clips
wget<span class="w"> </span>-O<span class="w"> </span>tf2_tracked_pose.clp<span class="w"> </span>https://raw.githubusercontent.com/fawkesrobotics/ros2-clips-executive/master/tutorials/clips_tut_agent/clips/tf2_tracked_pose.clp
</pre></div>
</div>
<p>The plugin code is taken from the <a class="reference external" href="https://fawkesrobotics.github.io/ros2-clips-executive/clips_executive/plugins/tf2_pose_tracker_plugin">Tf2PoseTrackerPlugin</a>. The code can be found on <a class="reference external" href="https://github.com/fawkesrobotics/ros2-clips-executive/blob/master/cx_plugins/tf2_pose_tracker_plugin">GitHub</a>.</p>
</section>
<section id="plugin-package-setup">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">2 Plugin Package Setup</a><a class="headerlink" href="#plugin-package-setup" title="Link to this heading"></a></h3>
<p>The plugin resides in it’s own ROS package, hence it has an appropriate <code class="docutils literal notranslate"><span class="pre">package.xml</span></code> and <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>. Additionally, each plugin comes with a plugin description that needs to be properly exported. See the
<a class="reference external" href="https://docs.ros.org/en/humble/Tutorials/Beginner-Client-Libraries/Pluginlib.html">beginner tutorial on pluginlib</a> for a general introduction to <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code> plugins.</p>
<p>Each plugin of the ROS2 CLIPS-Executive uses  the <code class="docutils literal notranslate"><span class="pre">cx::ClipsPlugin</span></code> as base class, provided by the <code class="docutils literal notranslate"><span class="pre">cx_plugin</span></code> package. The plugin for this tutorial is defined as a class <code class="docutils literal notranslate"><span class="pre">cx::Tf2PoseTrackerPlugin</span></code> and resides in the <code class="docutils literal notranslate"><span class="pre">cx_tf2_pose_tracker_plugin</span></code> package. The description file is shown below:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;class_libraries&gt;</span>
<span class="w">  </span><span class="nt">&lt;library</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;cx_tf2_pose_tracker_plugin&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;class</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;cx::Tf2PoseTrackerPlugin&quot;</span><span class="w"> </span><span class="na">base_class_type=</span><span class="s">&quot;cx::ClipsPlugin&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;description&gt;</span>Plugin<span class="w"> </span>to<span class="w"> </span>periodically<span class="w"> </span>track<span class="w"> </span>tf2<span class="w"> </span>poses.<span class="nt">&lt;/description&gt;</span>
<span class="w">    </span><span class="nt">&lt;/class&gt;</span>
<span class="w">  </span><span class="nt">&lt;/library&gt;</span>
<span class="nt">&lt;/class_libraries&gt;</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>, the description file needs to be properly exported</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">pluginlib_export_plugin_description_file</span><span class="p">(</span><span class="s">cx_plugin</span><span class="w"> </span><span class="s">tf2_pose_tracker_plugin.xml</span><span class="p">)</span>

<span class="nb">install</span><span class="p">(</span>
<span class="w">  </span><span class="s">FILES</span><span class="w"> </span><span class="s">tf2_pose_tracker_plugin.xml</span>
<span class="w">  </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">share/</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Also, the plugin needs to link against the namespaced CLIPS target provided by the <a class="reference external" href="https://docs.ros.org/en/humble/p/clips_vendor">clips_vendor</a> package, which is used thoughout the ROS2 CLIPS-Executive to interface with CLIPS.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This target wraps the original CLIPS code with a namespace <code class="docutils literal notranslate"><span class="pre">clips::</span></code>, hence the CLIPS features documented in the <a class="reference external" href="https://clipsrules.net/documentation/v641/apg641.pdf">Advanced Programming Guide (PDF)</a> require the namespace prefix.</p>
</div>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="w"> </span><span class="s">ClipsNS::libclips_ns</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="plugin-class-structure">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">3 Plugin Class Structure</a><a class="headerlink" href="#plugin-class-structure" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Tf2PoseTrackerPlugin</span></code> class inherits from <code class="docutils literal notranslate"><span class="pre">ClipsPlugin</span></code> base class provided by the <code class="docutils literal notranslate"><span class="pre">cx_plugin</span></code> package.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef CX_PLUGINS__TF2POSETRACKER_PLUGIN_HPP_</span>
<span class="cp">#define CX_PLUGINS__TF2POSETRACKER_PLUGIN_HPP_</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cx_plugin/clips_plugin.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cx_utils/lock_shared_ptr.hpp&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;geometry_msgs/msg/transform_stamped.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;tf2_ros/buffer.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;tf2_ros/transform_listener.h&gt;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">cx</span><span class="w"> </span><span class="p">{</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Tf2PoseTrackerPlugin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ClipsPlugin</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Tf2PoseTrackerPlugin</span><span class="p">();</span>
<span class="w">  </span><span class="o">~</span><span class="n">Tf2PoseTrackerPlugin</span><span class="p">();</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">finalize</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">clips_env_init</span><span class="p">(</span><span class="n">LockSharedPtr</span><span class="o">&lt;</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">clips_env_destroyed</span><span class="p">(</span><span class="n">LockSharedPtr</span><span class="o">&lt;</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">PoseTracker</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="w">    </span><span class="n">clips</span><span class="o">::</span><span class="n">Fact</span><span class="w"> </span><span class="o">*</span><span class="n">pose_fact</span><span class="p">;</span>
<span class="w">    </span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Logger</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logger_</span><span class="p">;</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tf_buffer_</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">TransformListener</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tf_listener_</span><span class="p">;</span>

<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroup</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">cb_group_</span><span class="p">;</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">PoseTracker</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">pose_trackers_</span><span class="p">;</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">start_periodic_lookup</span><span class="p">(</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span>
<span class="w">                             </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">frequency</span><span class="p">);</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">stop_periodic_lookup</span><span class="p">(</span><span class="n">PoseTracker</span><span class="w"> </span><span class="o">*</span><span class="n">pose_tracker</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace cx</span>

<span class="cp">#endif </span><span class="c1">// !CX_PLUGINS__TF2POSETRACKER_PLUGIN_HPP_</span>


<span class="n">As</span><span class="w"> </span><span class="n">such</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">generally</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="err">``</span><span class="n">initialize</span><span class="err">``</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="err">``</span><span class="n">finalize</span><span class="err">``</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">invoked</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">plugin</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">loaded</span><span class="p">,</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">well</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">``</span><span class="n">clips_env_init</span><span class="err">``</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="err">``</span><span class="n">clips_env_destoyed</span><span class="err">``</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">CLIPS</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">loads</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">unloads</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">plugin</span><span class="p">.</span>

<span class="p">..</span><span class="w"> </span><span class="n">code</span><span class="o">-</span><span class="n">block</span><span class="o">::</span><span class="w"> </span><span class="n">cpp</span>

<span class="w">      </span><span class="kt">void</span><span class="w"> </span><span class="n">initialize</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">      </span><span class="kt">void</span><span class="w"> </span><span class="nf">finalize</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="nf">clips_env_init</span><span class="p">(</span><span class="n">LockSharedPtr</span><span class="o">&lt;</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="nf">clips_env_destroyed</span><span class="p">(</span><span class="n">LockSharedPtr</span><span class="o">&lt;</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</pre></div>
</div>
<p>Also, it defines some data types and structures to access <code class="docutils literal notranslate"><span class="pre">tf2</span></code> transforms and ROS timers for periodic callbacks. The <code class="docutils literal notranslate"><span class="pre">PoseTracker</span></code> struct bundles a ROS timer with a managed CLIPS fact storing the last updated transform, as well as the belonging CLIPS environment.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">PoseTracker</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">Fact</span><span class="w"> </span><span class="o">*</span><span class="n">pose_fact</span><span class="p">;</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The different <code class="docutils literal notranslate"><span class="pre">PoseTracker</span></code> instances are stored in a vector, managing the lifetime of the objects.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">PoseTracker</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">pose_trackers_</span><span class="p">;</span>
</pre></div>
</div>
<p>Lastly, two helper functions are used that will be bound to CLIPS functions and will allow to create and destroy <code class="docutils literal notranslate"><span class="pre">PoseTracker</span></code> instances.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">start_periodic_lookup</span><span class="p">(</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span>
<span class="w">                           </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">frequency</span><span class="p">);</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">stop_periodic_lookup</span><span class="p">(</span><span class="n">PoseTracker</span><span class="w"> </span><span class="o">*</span><span class="n">pose_tracker</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="opening-ros-interfaces-on-initialize">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">4 Opening ROS Interfaces on initialize()</a><a class="headerlink" href="#opening-ros-interfaces-on-initialize" title="Link to this heading"></a></h3>
<p>Plugin initialization involves all steps that should be done, before any CLIPS environment can utilize it’s features.</p>
<p>Here, the transform listener is initialized with the help of the parent lifecycle node of the ROS2 CLIPS-Executive, provided from the base class.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Tf2PoseTrackerPlugin::initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">logger_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Logger</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="n">plugin_name_</span><span class="p">));</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">  </span><span class="c1">// fetch plugin parameter</span>
<span class="w">  </span><span class="n">cx</span><span class="o">::</span><span class="n">cx_utils</span><span class="o">::</span><span class="n">declare_parameter_if_not_declared</span><span class="p">(</span>
<span class="w">      </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">plugin_name_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.spin_thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ParameterValue</span><span class="p">(</span><span class="nb">true</span><span class="p">));</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">tf_spin_thread</span><span class="p">;</span>
<span class="w">  </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">plugin_name_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.spin_thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tf_spin_thread</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// setup transform listener</span>
<span class="w">  </span><span class="n">cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">create_callback_group</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroupType</span><span class="o">::</span><span class="n">Reentrant</span><span class="p">);</span>
<span class="w">  </span><span class="n">tf_buffer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">());</span>
<span class="w">  </span><span class="n">tf_listener_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">tf2_ros</span><span class="o">::</span><span class="n">TransformListener</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">      </span><span class="o">*</span><span class="n">tf_buffer_</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">get_node_base_interface</span><span class="p">(),</span>
<span class="w">      </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">get_node_logging_interface</span><span class="p">(),</span><span class="w"> </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">get_node_parameters_interface</span><span class="p">(),</span>
<span class="w">      </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">get_node_topics_interface</span><span class="p">(),</span><span class="w"> </span><span class="n">tf_spin_thread</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that plugins must provide default constructors. Information is only passed to a plugin after construction.
This is why the ROS logger is wrapped in a smart pointer (so it can be default-constructed), and only instanciated on the <code class="docutils literal notranslate"><span class="pre">initialize()</span></code> call, at which the actual plugin name is known (provided by the base class via <code class="docutils literal notranslate"><span class="pre">plugin_name_</span></code>).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">logger_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Logger</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="n">plugin_name_</span><span class="p">));</span>
</pre></div>
</div>
<p>Additionally, a plugin-specific parameter <code class="docutils literal notranslate"><span class="pre">spin_thread</span></code> is declared and retrieved, stored under the respective plugin name.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// fetch plugin parameter</span>
<span class="n">cx</span><span class="o">::</span><span class="n">cx_utils</span><span class="o">::</span><span class="n">declare_parameter_if_not_declared</span><span class="p">(</span>
<span class="w">    </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">plugin_name_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.spin_thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ParameterValue</span><span class="p">(</span><span class="nb">true</span><span class="p">));</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">tf_spin_thread</span><span class="p">;</span>
<span class="n">node</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">plugin_name_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.spin_thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tf_spin_thread</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="cleaning-up-references-on-finalize">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">5 Cleaning Up References On finalize()</a><a class="headerlink" href="#cleaning-up-references-on-finalize" title="Link to this heading"></a></h3>
<p>During finalize the plugin cleans up all data structures it manages, in this cas the transform listener with the associated buffer and callback group as well as all managed ROS timers for tracking specific poses.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Tf2PoseTrackerPlugin::finalize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// release all memory and cancel all timers</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pose_tracker</span><span class="o">:</span><span class="w"> </span><span class="n">pose_trackers_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">cancel</span><span class="p">();</span>
<span class="w">    </span><span class="n">clips</span><span class="o">::</span><span class="n">ReleaseFact</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// release references</span>
<span class="w">  </span><span class="n">pose_trackers_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">  </span><span class="n">logger_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="w">  </span><span class="n">tf_buffer_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="w">  </span><span class="n">tf_listener_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="w">  </span><span class="n">cb_group_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In particular, all timers are properly cancelled and all references to CLIPS data is released for garbage collection.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Special care is required when handling data from CLIPS, as CLIPS manages it’s memory including garbage collection as needed. <code class="docutils literal notranslate"><span class="pre">Retain</span></code> and <code class="docutils literal notranslate"><span class="pre">Release</span></code> functions are provided to safely interact with data.</p>
</div>
</section>
<section id="adding-templates-and-functions-in-clips-env-init">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">6 Adding Templates and Functions in clips_env_init()</a><a class="headerlink" href="#adding-templates-and-functions-in-clips-env-init" title="Link to this heading"></a></h3>
<p>Upon loading a plugin into an environment, the <code class="docutils literal notranslate"><span class="pre">clips_env_init()</span></code> function is invoked.</p>
<p>Here, a fact template is declared and two user-defined functions (UDFs) are provided to the environment.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">Tf2PoseTrackerPlugin::clips_env_init</span><span class="p">(</span>
<span class="w">    </span><span class="n">LockSharedPtr</span><span class="o">&lt;</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CLIPSEnvContext</span><span class="o">::</span><span class="n">get_context</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">get_obj</span><span class="p">().</span><span class="n">get</span><span class="p">());</span>
<span class="w">  </span><span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="o">*</span><span class="n">logger_</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Initializing plugin for environment %s&quot;</span><span class="p">,</span>
<span class="w">               </span><span class="n">context</span><span class="o">-&gt;</span><span class="n">env_name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

<span class="w">  </span><span class="c1">// define fact template</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">Build</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">get_obj</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;(deftemplate tf2-tracked-pose \</span>
<span class="s">            (slot parent (type STRING)) \</span>
<span class="s">            (slot child (type STRING)) \</span>
<span class="s">            (slot stamp (type FLOAT)) \</span>
<span class="s">            (multislot translation (type FLOAT) (cardinality 3 3)) \</span>
<span class="s">            (multislot rotation (type FLOAT) (cardinality 4 4)) \</span>
<span class="s">            (slot timer (type EXTERNAL-ADDRESS)) \</span>
<span class="s">)&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// user defined functions</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">AddUDF</span><span class="p">(</span>
<span class="w">      </span><span class="n">env</span><span class="p">.</span><span class="n">get_obj</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;tf2-start-periodic-lookup&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;;sy;sy;d&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">[](</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFContext</span><span class="w"> </span><span class="o">*</span><span class="n">udfc</span><span class="p">,</span>
<span class="w">         </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFValue</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Tf2PoseTrackerPlugin</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">udfc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="w">        </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFValue</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">freq</span><span class="p">;</span>
<span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">clips</span><span class="p">;</span>
<span class="w">        </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">LEXEME_BITS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="p">);</span>
<span class="w">        </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">LEXEME_BITS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">child</span><span class="p">);</span>
<span class="w">        </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">NUMBER_BITS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">freq</span><span class="p">);</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">start_periodic_lookup</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="n">lexemeValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">child</span><span class="p">.</span><span class="n">lexemeValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">freq</span><span class="p">.</span><span class="n">floatValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">);</span>
<span class="w">          </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">lexemeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateBoolean</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="o">*</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">logger_</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to create pose updater: %s&quot;</span><span class="p">,</span>
<span class="w">                       </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="w">          </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">lexemeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateBoolean</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s">&quot;tf2_start_periodic_lookup&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>

<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">AddUDF</span><span class="p">(</span>
<span class="w">      </span><span class="n">env</span><span class="p">.</span><span class="n">get_obj</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;tf2-stop-periodic-lookup&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;;e&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">[](</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFContext</span><span class="w"> </span><span class="o">*</span><span class="n">udfc</span><span class="p">,</span>
<span class="w">         </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFValue</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Tf2PoseTrackerPlugin</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">udfc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="w">        </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFValue</span><span class="w"> </span><span class="n">pose_tracker</span><span class="p">;</span>
<span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">clips</span><span class="p">;</span>
<span class="w">        </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">EXTERNAL_ADDRESS_BIT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pose_tracker</span><span class="p">);</span>
<span class="w">        </span><span class="n">PoseTracker</span><span class="w"> </span><span class="o">*</span><span class="n">typed_pose_tracker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">PoseTracker</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">pose_tracker</span><span class="p">.</span><span class="n">externalAddressValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">);</span>
<span class="w">        </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">lexemeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateBoolean</span><span class="p">(</span>
<span class="w">            </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">stop_periodic_lookup</span><span class="p">(</span><span class="n">typed_pose_tracker</span><span class="p">));</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s">&quot;tf2_stop_periodic_lookup&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="accessing-clips-environments-safely">
<h4>6.1 Accessing CLIPS Environments Safely<a class="headerlink" href="#accessing-clips-environments-safely" title="Link to this heading"></a></h4>
<p>Importantly, the environment is provided wrapped in a <code class="docutils literal notranslate"><span class="pre">LockSharedPtr</span></code>, wich holds both a shared pointer and a mutex. CLIPS is not thread-safe, hence interactions with CLIPS need to be guarded whenever asynchronous access happens (and must not be guarded if it happens within the main context, where the lock is already acquired).</p>
<p>In short, locking the mutex associated with a CLIPS environment is only needed, once asynchronous operations want to interact with it.</p>
<p>In particular, the environment is already guarded by the mutex when entering <code class="docutils literal notranslate"><span class="pre">clips_env_init()</span></code> (invoked by the environment manager node), and it is safe to directly interact with the provided environment in this scope.</p>
</section>
<section id="access-to-environment-context">
<h4>6.2 Access to Environment Context<a class="headerlink" href="#access-to-environment-context" title="Link to this heading"></a></h4>
<p>The function starts with a simple debugging statement that utilizes the plugins ROS logger to print for which environment the plugin is initialized. This requires accessing the context stored in each environment managed by the ROS2 CLIPS-Executive, as this is where custom data, such as the user-assigned name of each environment, is stored.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">auto</span> <span class="n">context</span> <span class="o">=</span> <span class="n">CLIPSEnvContext</span><span class="p">::</span><span class="n">get_context</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get_obj</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">());</span>
<span class="n">RCLCPP_DEBUG</span><span class="p">(</span><span class="o">*</span><span class="n">logger_</span><span class="p">,</span> <span class="s2">&quot;Initializing plugin for environment </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">context</span><span class="o">-&gt;</span><span class="n">env_name_</span><span class="o">.</span><span class="n">c_str</span><span class="p">());</span>
</pre></div>
</div>
</section>
<section id="constructs-via-build-function">
<h4>6.3 Constructs via Build Function<a class="headerlink" href="#constructs-via-build-function" title="Link to this heading"></a></h4>
<p>Next, the <code class="docutils literal notranslate"><span class="pre">Build</span></code> function is used to construct a deftemplate for the environment from a string representation.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// define fact template</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">Build</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">get_obj</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;(deftemplate tf2-tracked-pose \</span>
<span class="s">            (slot parent (type STRING)) \</span>
<span class="s">            (slot child (type STRING)) \</span>
<span class="s">            (slot stamp (type FLOAT)) \</span>
<span class="s">            (multislot translation (type FLOAT) (cardinality 3 3)) \</span>
<span class="s">            (multislot rotation (type FLOAT) (cardinality 4 4)) \</span>
<span class="s">            (slot timer (type EXTERNAL-ADDRESS)) \</span>
<span class="s">)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="user-defined-functions">
<h4>6.4 User-Defined Functions<a class="headerlink" href="#user-defined-functions" title="Link to this heading"></a></h4>
<p>A common motivation for writing plugins is to provide more functions that can be called in CLIPS. In the following, the definition for the first function “tf2-start-periodic-lookup” is examined more closely.
The corresponding <code class="docutils literal notranslate"><span class="pre">AddUDF</span></code> call needs the following arguments:</p>
<ul class="simple">
<li><p>A raw pointer to the <code class="docutils literal notranslate"><span class="pre">Environment</span></code> object that should register the user-defined function.</p></li>
<li><p>The name of the function in CLIPS.</p></li>
<li><p>The return specifier (here <code class="docutils literal notranslate"><span class="pre">b</span></code> for a boolean)</p></li>
<li><p>Min and max number of arguments (exactly 3 in this case)</p></li>
<li><p>The types of the function arguments, separated by <code class="docutils literal notranslate"><span class="pre">;</span></code> and starting with a fallback type, in this case left blank. <code class="docutils literal notranslate"><span class="pre">sy</span></code> indicates that both symbols and strings are accepted, <code class="docutils literal notranslate"><span class="pre">d</span></code> denotes floats.</p></li>
<li><p>The function to invoke, which takes as arguments the environment pointer, a <code class="docutils literal notranslate"><span class="pre">UDFContext</span></code> for passing more data into the function and an output parameter storing the return value of the function. The function itself has no return value (void).</p></li>
<li><p>An internal name for storing the function in the backend.</p></li>
<li><p>Context that can be accessed when the function is invoked via the <code class="docutils literal notranslate"><span class="pre">UDFContext</span></code> argument (here, the reference to the plugin itself is passed as context to invoke some helper functions of the plugin).</p></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// user defined functions</span>
<span class="n">clips</span><span class="o">::</span><span class="n">AddUDF</span><span class="p">(</span>
<span class="w">    </span><span class="n">env</span><span class="p">.</span><span class="n">get_obj</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;tf2-start-periodic-lookup&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;;sy;sy;d&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">[](</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFContext</span><span class="w"> </span><span class="o">*</span><span class="n">udfc</span><span class="p">,</span>
<span class="w">       </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFValue</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Tf2PoseTrackerPlugin</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">udfc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="w">      </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFValue</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">freq</span><span class="p">;</span>
<span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">clips</span><span class="p">;</span>
<span class="w">      </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">LEXEME_BITS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="p">);</span>
<span class="w">      </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">LEXEME_BITS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">child</span><span class="p">);</span>
<span class="w">      </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">NUMBER_BITS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">freq</span><span class="p">);</span>

<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">start_periodic_lookup</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="n">lexemeValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">,</span>
<span class="w">                                        </span><span class="n">child</span><span class="p">.</span><span class="n">lexemeValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">,</span>
<span class="w">                                        </span><span class="n">freq</span><span class="p">.</span><span class="n">floatValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">);</span>
<span class="w">        </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">lexemeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateBoolean</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="o">*</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">logger_</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to create pose updater: %s&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="w">        </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">lexemeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateBoolean</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s">&quot;tf2_start_periodic_lookup&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
</pre></div>
</div>
<p>Inside of the lambda function, the first step is to reconstruct the passed context via casting the held void reference to the appropriate type:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Tf2PoseTrackerPlugin</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">udfc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
</pre></div>
</div>
<p>Next, the function arguments are retrieved. Since the number of arguments is fixed, this can be achieved using the <code class="docutils literal notranslate"><span class="pre">UDFNthArgument</span></code> function.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">clips</span><span class="o">::</span><span class="n">UDFValue</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">freq</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">clips</span><span class="p">;</span>
<span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">LEXEME_BITS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="p">);</span>
<span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">LEXEME_BITS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">child</span><span class="p">);</span>
<span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">NUMBER_BITS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">freq</span><span class="p">);</span>
</pre></div>
</div>
<p>However, this snippet also showcases an unfortunate drawback when using a namespaced version of the CLIPS library, which is also mentioned in the known issues of the <a class="reference external" href="https://docs.ros.org/en/humble/p/clips_vendor">clips_vendor</a> package: The <code class="docutils literal notranslate"><span class="pre">LEXEME_BITS</span></code> and <code class="docutils literal notranslate"><span class="pre">NUMBER_BITS</span></code> statements are macros that extend to a disjunction of enum types, which are not properly namespaced.
Hence, the <code class="docutils literal notranslate"><span class="pre">using</span> <span class="pre">namespace</span> <span class="pre">clips;</span></code> directive is necessary here to properly use the macros.</p>
<p>Lastly, the helper function <code class="docutils literal notranslate"><span class="pre">start_periodic_lookup</span></code> is called using the context.
The CLIPS arguments are converted to their native C++ types, before they are passed at arguments to the helper function.
<code class="docutils literal notranslate"><span class="pre">STRING</span></code> and <code class="docutils literal notranslate"><span class="pre">SYMBOL</span></code> types are stored a C-style strings (via <code class="docutils literal notranslate"><span class="pre">lexemeValue</span></code>), while <code class="docutils literal notranslate"><span class="pre">FLOAT</span></code> values are mapped to <code class="docutils literal notranslate"><span class="pre">double</span></code> (via <code class="docutils literal notranslate"><span class="pre">floatValue</span></code>).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">start_periodic_lookup</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="n">lexemeValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">,</span>
<span class="w">                                    </span><span class="n">child</span><span class="p">.</span><span class="n">lexemeValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">,</span>
<span class="w">                                    </span><span class="n">freq</span><span class="p">.</span><span class="n">floatValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">);</span>
<span class="w">    </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">lexemeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateBoolean</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="o">*</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">logger_</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to create pose updater: %s&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="w">    </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">lexemeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateBoolean</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">},</span>
</pre></div>
</div>
<p>The output parameter is populated by creating a boolean indicating the success of the attempted helper function call.</p>
<p>The second UDF is populated in much of the same way, this time taking an external address (void <a href="#id1"><span class="problematic" id="id2">*</span></a>) as argument, which needs to be casted to it’s expected type.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">clips</span><span class="o">::</span><span class="n">AddUDF</span><span class="p">(</span>
<span class="w">    </span><span class="n">env</span><span class="p">.</span><span class="n">get_obj</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;tf2-stop-periodic-lookup&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;;e&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">[](</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFContext</span><span class="w"> </span><span class="o">*</span><span class="n">udfc</span><span class="p">,</span>
<span class="w">       </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFValue</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Tf2PoseTrackerPlugin</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">udfc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="w">      </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFValue</span><span class="w"> </span><span class="n">pose_tracker</span><span class="p">;</span>
<span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">clips</span><span class="p">;</span>
<span class="w">      </span><span class="n">clips</span><span class="o">::</span><span class="n">UDFNthArgument</span><span class="p">(</span><span class="n">udfc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">EXTERNAL_ADDRESS_BIT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pose_tracker</span><span class="p">);</span>
<span class="w">      </span><span class="n">PoseTracker</span><span class="w"> </span><span class="o">*</span><span class="n">typed_pose_tracker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">PoseTracker</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span>
<span class="w">          </span><span class="n">pose_tracker</span><span class="p">.</span><span class="n">externalAddressValue</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">);</span>
<span class="w">      </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">lexemeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateBoolean</span><span class="p">(</span>
<span class="w">          </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">stop_periodic_lookup</span><span class="p">(</span><span class="n">typed_pose_tracker</span><span class="p">));</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s">&quot;tf2_stop_periodic_lookup&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The body of each UDF can safely access CLIPS because the context that invokes the function should ensure that the environment is locked already, typically this is the <code class="docutils literal notranslate"><span class="pre">ExecutivePlugin</span></code> that handles the CLIPS inference engine runs. Do not try to lock the environment again within the execution scope of a UDF.</p>
</div>
<p>7 Asynchronous Handling of CLIPS facts in start_periodic_lookup()</p>
<p>THe start_periodic_lookup function is responsible for creating a ROS timer that queries the transform tree and updates a fact to store the latest update to the retrieved pose.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Tf2PoseTrackerPlugin::start_periodic_lookup</span><span class="p">(</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span>
<span class="w">                                                 </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span>
<span class="w">                                                 </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">child</span><span class="p">,</span>
<span class="w">                                                 </span><span class="kt">double</span><span class="w"> </span><span class="n">frequency</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="o">::</span><span class="nn">chrono_literals</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">PoseTracker</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pose_tracker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">PoseTracker</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span><span class="p">;</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">  </span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">frequency</span><span class="p">),</span>
<span class="w">      </span><span class="p">[</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">pose_tracker</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">TransformStamped</span><span class="w"> </span><span class="n">tf</span><span class="p">;</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>

<span class="w">          </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf_buffer_</span><span class="o">-&gt;</span><span class="n">lookupTransform</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">tf2</span><span class="o">::</span><span class="n">TimePointZero</span><span class="p">);</span>
<span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">stamp_sec</span><span class="w"> </span><span class="o">=</span>
<span class="w">              </span><span class="n">tf</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">sec</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">nanosec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">;</span>

<span class="w">          </span><span class="c1">// safely access CLIPS environment</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CLIPSEnvContext</span><span class="o">::</span><span class="n">get_context</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
<span class="w">          </span><span class="n">cx</span><span class="o">::</span><span class="n">LockSharedPtr</span><span class="o">&lt;</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">clips</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="o">-&gt;</span><span class="n">env_lock_ptr_</span><span class="p">;</span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">scoped_lock</span><span class="w"> </span><span class="n">clips_lock</span><span class="p">{</span><span class="o">*</span><span class="n">clips</span><span class="p">.</span><span class="n">get_mutex_instance</span><span class="p">()};</span>

<span class="w">          </span><span class="c1">// update exisiting fact or create new one</span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">fact_exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">FactExistp</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">fact_exists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="c1">// fact was retained before but did not survive the engine, this</span>
<span class="w">              </span><span class="c1">// is not supposed to happen</span>
<span class="w">              </span><span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="o">*</span><span class="n">logger_</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;TF lookup from %s to %s: fact was retained but does &quot;</span>
<span class="w">                          </span><span class="s">&quot;not exist anymore&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">parent</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">              </span><span class="n">clips</span><span class="o">::</span><span class="n">ReleaseFact</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// New fact needed, build and retain it</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FactBuilder</span><span class="w"> </span><span class="o">*</span><span class="n">fact_builder</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateFactBuilder</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tf2-tracked-pose&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotCLIPSExternalAddress</span><span class="p">(</span>
<span class="w">                </span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;timer&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateCExternalAddress</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">pose_tracker</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotString</span><span class="p">(</span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;parent&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotString</span><span class="p">(</span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;child&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotFloat</span><span class="p">(</span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stamp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">stamp_sec</span><span class="p">);</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotMultifield</span><span class="p">(</span>
<span class="w">                </span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;translation&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">clips</span><span class="o">::</span><span class="n">StringToMultifield</span><span class="p">(</span>
<span class="w">                    </span><span class="n">clips</span><span class="p">.</span><span class="n">get_obj</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;{} {} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">                                </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="w">                                </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotMultifield</span><span class="p">(</span>
<span class="w">                </span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;rotation&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">clips</span><span class="o">::</span><span class="n">StringToMultifield</span><span class="p">(</span>
<span class="w">                    </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;{} {} {} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
<span class="w">                             </span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="w">            </span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">FBAssert</span><span class="p">(</span><span class="n">fact_builder</span><span class="p">);</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">RetainFact</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FBDispose</span><span class="p">(</span><span class="n">fact_builder</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// the fact exists and can can be modified</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">ReleaseFact</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FactModifier</span><span class="w"> </span><span class="o">*</span><span class="n">fact_modifier</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateFactModifier</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FMPutSlotFloat</span><span class="p">(</span><span class="n">fact_modifier</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stamp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">stamp_sec</span><span class="p">);</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FMPutSlotMultifield</span><span class="p">(</span>
<span class="w">                </span><span class="n">fact_modifier</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;translation&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">clips</span><span class="o">::</span><span class="n">StringToMultifield</span><span class="p">(</span>
<span class="w">                    </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;{} {} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="w">                             </span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FMPutSlotMultifield</span><span class="p">(</span>
<span class="w">                </span><span class="n">fact_modifier</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;rotation&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">clips</span><span class="o">::</span><span class="n">StringToMultifield</span><span class="p">(</span>
<span class="w">                    </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;{} {} {} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
<span class="w">                             </span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="w">            </span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">FMModify</span><span class="p">(</span><span class="n">fact_modifier</span><span class="p">);</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">RetainFact</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">            </span><span class="n">clips</span><span class="o">::</span><span class="n">FMDispose</span><span class="p">(</span><span class="n">fact_modifier</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">tf2</span><span class="o">::</span><span class="n">TransformException</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="o">*</span><span class="n">logger_</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TF lookup failed: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="n">cb_group_</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// store the pose tracker</span>
<span class="w">  </span><span class="n">pose_trackers_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pose_tracker</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="guarding-the-clips-environment-from-concurrent-access">
<h4>7.1 Guarding the CLIPS Environment from Concurrent Access<a class="headerlink" href="#guarding-the-clips-environment-from-concurrent-access" title="Link to this heading"></a></h4>
<p>This asynchronous task showcases the need for guarding the CLIPS environment from concurrent access.</p>
<p>While the UDF function body itself is guarded already, the callback of the created ROS timer is not.
Since the ROS2 CLIPS-Executive itself is ran via a <a class="reference external" href="https://docs.ros.org/en/humble//Concepts/Intermediate/About-Executors.html">MultiThreadedExecutor</a>, ROS callbacks are typically executed in parallel.</p>
<p>In order to obtain the required mutex, the environment context is retrieved. Then a scoped lock protects the remainder of this scope.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// safely access CLIPS environment</span>
<span class="k">auto</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CLIPSEnvContext</span><span class="o">::</span><span class="n">get_context</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
<span class="n">cx</span><span class="o">::</span><span class="n">LockSharedPtr</span><span class="o">&lt;</span><span class="n">clips</span><span class="o">::</span><span class="n">Environment</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">clips</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="o">-&gt;</span><span class="n">env_lock_ptr_</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">scoped_lock</span><span class="w"> </span><span class="n">clips_lock</span><span class="p">{</span><span class="o">*</span><span class="n">clips</span><span class="p">.</span><span class="n">get_mutex_instance</span><span class="p">()};</span>
</pre></div>
</div>
</section>
<section id="creating-and-modifying-facts">
<h4>7.2 Creating and Modifying Facts<a class="headerlink" href="#creating-and-modifying-facts" title="Link to this heading"></a></h4>
<p>The next step is to either create the initial fact for the data, or to update the previously asserted one with the new information.</p>
<p>For this, it is first checked, whether a new fact needs to be asserted (releasing the outdated fact reference if needed):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// update exisiting fact or create new one</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">fact_exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">FactExistp</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">fact_exists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// fact was retained before but did not survive the engine, this</span>
<span class="w">    </span><span class="c1">// is not supposed to happen</span>
<span class="w">    </span><span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="o">*</span><span class="n">logger_</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;TF lookup from %s to %s: fact was retained but does &quot;</span>
<span class="w">                </span><span class="s">&quot;not exist anymore&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">parent</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="n">clips</span><span class="o">::</span><span class="n">ReleaseFact</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>In case a new fact is needed, it can be created via the FactBuilder API. The resulting reference to the fact is retained to update it in subsequent iterations.
The <code class="docutils literal notranslate"><span class="pre">timer</span></code> slot is used to also hand a reference to the pose tracker object managing this timer, which can be used to stop the timer using the respective UDF.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// New fact needed, build and retain it</span>
<span class="n">clips</span><span class="o">::</span><span class="n">FactBuilder</span><span class="w"> </span><span class="o">*</span><span class="n">fact_builder</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateFactBuilder</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tf2-tracked-pose&quot;</span><span class="p">);</span>
<span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotCLIPSExternalAddress</span><span class="p">(</span>
<span class="w">    </span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;timer&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateCExternalAddress</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">pose_tracker</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
<span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotString</span><span class="p">(</span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;parent&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotString</span><span class="p">(</span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;child&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotFloat</span><span class="p">(</span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stamp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">stamp_sec</span><span class="p">);</span>
<span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotMultifield</span><span class="p">(</span>
<span class="w">    </span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;translation&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">clips</span><span class="o">::</span><span class="n">StringToMultifield</span><span class="p">(</span>
<span class="w">        </span><span class="n">clips</span><span class="p">.</span><span class="n">get_obj</span><span class="p">().</span><span class="n">get</span><span class="p">(),</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;{} {} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">                    </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="w">                    </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="n">clips</span><span class="o">::</span><span class="n">FBPutSlotMultifield</span><span class="p">(</span>
<span class="w">    </span><span class="n">fact_builder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;rotation&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">clips</span><span class="o">::</span><span class="n">StringToMultifield</span><span class="p">(</span>
<span class="w">        </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;{} {} {} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">                         </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="w">                         </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="w">                         </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
<span class="w">                 </span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">FBAssert</span><span class="p">(</span><span class="n">fact_builder</span><span class="p">);</span>
<span class="n">clips</span><span class="o">::</span><span class="n">RetainFact</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="n">clips</span><span class="o">::</span><span class="n">FBDispose</span><span class="p">(</span><span class="n">fact_builder</span><span class="p">);</span>
</pre></div>
</div>
<p>Similarly, if the last remembered fact still exists, the FactModifier API is used. Additionally, the old fact reference is released to mark it for garbage collection and the new reference is retained.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// the fact exists and can can be modified</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">ReleaseFact</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">FactModifier</span><span class="w"> </span><span class="o">*</span><span class="n">fact_modifier</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">clips</span><span class="o">::</span><span class="n">CreateFactModifier</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">FMPutSlotFloat</span><span class="p">(</span><span class="n">fact_modifier</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stamp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">stamp_sec</span><span class="p">);</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">FMPutSlotMultifield</span><span class="p">(</span>
<span class="w">      </span><span class="n">fact_modifier</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;translation&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">clips</span><span class="o">::</span><span class="n">StringToMultifield</span><span class="p">(</span>
<span class="w">          </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;{} {} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">                           </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="w">                           </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="w">                   </span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">FMPutSlotMultifield</span><span class="p">(</span>
<span class="w">      </span><span class="n">fact_modifier</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;rotation&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">clips</span><span class="o">::</span><span class="n">StringToMultifield</span><span class="p">(</span>
<span class="w">          </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;{} {} {} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">                           </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="w">                           </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="w">                           </span><span class="n">tf</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
<span class="w">                   </span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="w">  </span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clips</span><span class="o">::</span><span class="n">FMModify</span><span class="p">(</span><span class="n">fact_modifier</span><span class="p">);</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">RetainFact</span><span class="p">(</span><span class="n">pose_tracker</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">  </span><span class="n">clips</span><span class="o">::</span><span class="n">FMDispose</span><span class="p">(</span><span class="n">fact_modifier</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This concludes the callback function of the pose tracker, which then is stored to a vector to manage it’s lifetime, completing the task to to create a pose tracker.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// store the pose tracker</span>
<span class="n">pose_trackers_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pose_tracker</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="cleaning-up-with-the-help-of-stop-periodic-lookup">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">8 Cleaning Up with the Help of stop_periodic_lookup()</a><a class="headerlink" href="#cleaning-up-with-the-help-of-stop-periodic-lookup" title="Link to this heading"></a></h3>
<p>The last thing that is left is to stop the pose tracker on demand, given the raw reference to it (as stored previously in the <code class="docutils literal notranslate"><span class="pre">timer</span></code> slot).
When locating the stored <code class="docutils literal notranslate"><span class="pre">PoseTracker</span></code>, it’s timer is cancelled and the associated fact is released for garbage collection (but not retracted), before it is removed from the vector, which cleans up the object.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">Tf2PoseTrackerPlugin::stop_periodic_lookup</span><span class="p">(</span><span class="n">PoseTracker</span><span class="w"> </span><span class="o">*</span><span class="n">pose_tracker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// lookup active updater, cancel the timer and release the fact address</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">pose_trackers_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">pose_trackers_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
<span class="w">                         </span><span class="p">[</span><span class="n">pose_tracker</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">PoseTracker</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pose_tracker</span><span class="p">;</span>
<span class="w">                         </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pose_trackers_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">clips</span><span class="o">::</span><span class="n">ReleaseFact</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pose_fact</span><span class="p">);</span>
<span class="w">    </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">cancel</span><span class="p">();</span>
<span class="w">    </span><span class="n">pose_trackers_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="o">*</span><span class="n">logger_</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tf2-stop-periodic-lookup: failed to stop periodic &quot;</span>
<span class="w">                          </span><span class="s">&quot;lookup, invalid pointer!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="running-the-code">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">9 Running The Code</a><a class="headerlink" href="#running-the-code" title="Link to this heading"></a></h3>
<p>Open a terminal and start the tf2 turtlesim demo:</p>
<div class="highlight-terminal notranslate"><div class="highlight"><pre><span></span>ros2 launch turtle_tf2_py turtle_tf2_demo.launch.py
</pre></div>
</div>
<p>In a second terminal run the example setup for the plugin:</p>
<div class="highlight-terminal notranslate"><div class="highlight"><pre><span></span>ros2 launch cx_bringup cx_launch.py manager_config:=tf2_tracked_pose.yaml package:=clips_tut_agent
</pre></div>
</div>
<p>It will track the pose of turtle1 with a frequency of 0.2 hz and stop the tracking after 5 updates.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ros_monitoring.html" class="btn btn-neutral float-left" title="Continuous Monitoring" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tarik Viehmann.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>